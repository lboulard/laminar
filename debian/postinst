#!/bin/sh
# postinst script for laminar
#
# see: dh_installdeb(1)

set -e

. /usr/share/debconf/confmodule

db_get laminar/user; user="${RET:-laminar}";
db_get laminar/workdir; workdir="${RET:-/var/lib/laminar}"

systemd_local_conf=/lib/systemd/system/laminar.service.d/debian.conf

setup_laminar() {
    if ! getent passwd "$user" >/dev/null ; then
        useradd --system -d "$workdir" -s /usr/sbin/nologin "$user"
    fi
    # Override default user from service
    if [ "$user" != "laminar" ] || [ "$DEBCONF_RECONFIGURE" = "1" ] ; then
        if [ ! -e "$systemd_local_conf" ] ; then
            mkdir -p "$(dirname "$systemd_local_conf")"
            { echo "[Service]"; echo "User=$user"; } \
                >> "$systemd_local_conf"
        fi
    fi
    if [ ! -d "$workdir" ] || [ "$DEBCONF_RECONFIGURE" = "1" ] ; then
        mkdir -p "$workdir/cfg/jobs"
        mkdir -p "$workdir/cfg/nodes"
        mkdir -p "$workdir/cfg/scripts"
        chown -R "$user:" "$workdir/cfg"
    fi
}

case "$1" in
    reconfigure)
        DEBCONF_RECONFIGURE=1
        setup_laminar
    ;;

    configure)
        setup_laminar
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
